<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>P2P Trading Playground</title>
    <style>
        :root {
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            color-scheme: light;
            --bg: #f5f7fb;
            --surface: #ffffff;
            --surface-alt: #f1f5ff;
            --border: #d8e0f5;
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --text: #1f2937;
            --muted: #64748b;
            --success: #0f766e;
            --danger: #b91c1c;
        }
        * { box-sizing: border-box; }
        body { margin: 0; background: radial-gradient(circle at top right, rgba(37,99,235,0.08), transparent 40%), var(--bg); color: var(--text); }
        header { padding: 28px 36px 18px; color: var(--text); }
        header h1 { margin: 0 0 6px; font-size: 28px; font-weight: 700; letter-spacing: 0.2px; }
        header p { margin: 0; color: var(--muted); }
        main { padding: 0 36px 40px; display: grid; gap: 24px; }
        section { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 24px 26px; box-shadow: 0 18px 38px rgba(15, 23, 42, 0.08); display: grid; gap: 18px; }
        h2 { margin: 0; font-size: 19px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        form, .settings { display: grid; gap: 14px; }
        .card-grid { display: grid; gap: 18px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
        label { display: grid; gap: 6px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); }
        input, select, textarea { padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: #f8fafc; font-size: 14px; transition: border 0.2s, box-shadow 0.2s, background 0.2s; }
        textarea { min-height: 80px; resize: vertical; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); }
        button { cursor: pointer; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; padding: 12px 18px; color: #fff; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); box-shadow: 0 16px 26px rgba(37, 99, 235, 0.22); transition: transform 0.15s, box-shadow 0.15s; }
        button:hover { transform: translateY(-1px); box-shadow: 0 18px 32px rgba(37, 99, 235, 0.26); }
        button.secondary { background: linear-gradient(135deg, #6b7280, #4b5563); box-shadow: 0 12px 24px rgba(107, 114, 128, 0.18); }
        .row { display: flex; flex-wrap: wrap; gap: 14px; }
        .row > * { flex: 1 1 210px; }
        .chip-bar { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip { padding: 6px 12px; border-radius: 999px; border: 1px solid var(--border); background: #fff; cursor: pointer; font-size: 13px; transition: background 0.15s, border 0.15s, color 0.15s; }
        .chip.active { background: var(--primary); border-color: var(--primary); color: #fff; box-shadow: 0 8px 18px rgba(37,99,235,0.25); }
        .token-display { border-radius: 14px; background: linear-gradient(135deg, #eef2ff, #dee7ff); padding: 14px 16px; font-family: "Roboto Mono", monospace; font-size: 13px; word-break: break-all; }
        .token-display span { font-weight: 600; color: var(--muted); margin-right: 8px; }
        .result-card { background: var(--surface-alt); border: 1px solid var(--border); border-radius: 14px; padding: 18px; display: grid; gap: 12px; }
        .result-card h3 { margin: 0; font-size: 15px; }
        .info-line { font-size: 13px; color: var(--muted); }
        .info-line strong { color: var(--text); }
        .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 999px; font-size: 11px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; }
        .badge.BUY { background: rgba(14, 159, 110, 0.18); color: #047857; }
        .badge.SELL { background: rgba(220, 38, 38, 0.18); color: #b91c1c; }
        .badge.OPEN { background: rgba(37, 99, 235, 0.18); color: #1d4ed8; }
        table { width: 100%; border-collapse: collapse; border-radius: 14px; overflow: hidden; background: #fff; box-shadow: 0 10px 24px rgba(15, 23, 42, 0.09); }
        th, td { padding: 12px 14px; border-bottom: 1px solid #e2e8f0; text-align: left; font-size: 13px; }
        th { background: #f3f6ff; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); }
        tr:hover td { background: #f8fbff; }
        .meta { display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px; color: var(--muted); }
        .meta strong { color: var(--text); }
        .pill { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 999px; font-size: 11px; font-weight: 600; letter-spacing: 0.05em; }
        .pill.success { background: rgba(16, 185, 129, 0.18); color: var(--success); }
        .pill.error { background: rgba(239, 68, 68, 0.18); color: var(--danger); }
        .wallet-grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
        .wallet-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 14px; box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08); display: grid; gap: 6px; }
        .wallet-card h4 { margin: 0; font-size: 14px; }
        .wallet-card span { font-size: 12px; color: var(--muted); }
        .notification-list { display: grid; gap: 12px; }
        .notification { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 14px; box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08); }
        .notification h4 { margin: 0 0 6px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .notification time { font-size: 12px; color: var(--muted); }
        .empty-state { padding: 18px; border-radius: 12px; background: rgba(37, 99, 235, 0.08); border: 1px dashed rgba(37, 99, 235, 0.45); color: var(--primary-dark); font-size: 13px; }
        .raw-output { background: #0f172a; color: #e2e8f0; border-radius: 14px; padding: 20px; font-family: "Roboto Mono", monospace; font-size: 13px; max-height: 45vh; overflow: auto; }
        .note { font-size: 13px; color: var(--muted); }
        @media (max-width: 900px) {
            header, main { padding-left: 20px; padding-right: 20px; }
            .row > * { flex: 1 1 100%; }
        }
    </style>
</head>
<body>
<header>
    <h1>P2P Trading Playground</h1>
    <p>Đăng nhập, tạo order và tạo trade để kiểm thử nhanh các API P2P.</p>
</header>
<main>
    <section>
        <h2>01 · Environment</h2>
        <div class="settings">
            <div class="row">
                <label>Base URL
                    <input id="baseUrl" type="text" value="http://localhost:8080" />
                </label>
                <label>API Prefix
                    <input id="apiPrefix" type="text" value="/api" />
                </label>
            </div>
            <label>Token
                <div class="row">
                    <input id="tokenInput" type="text" placeholder="JWT sẽ tự động fill sau khi login" />
                    <button type="button" onclick="applyToken()">Use Token</button>
                    <button type="button" class="secondary" onclick="clearToken()">Clear</button>
                </div>
            </label>
            <div class="token-display"><span>Active:</span><span id="activeToken">(none)</span></div>
            <div class="row">
                <button type="button" onclick="applyBaseUrl()">Apply Environment</button>
            </div>
        </div>
    </section>

    <section>
        <h2>02 · Authentication</h2>
        <p class="note">Nhập email/password hợp lệ. Token sẽ tự động được set và lưu cục bộ sau khi đăng nhập thành công.</p>
        <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="row">
                <label>Email
                    <input name="email" type="email" placeholder="user@example.com" required />
                </label>
                <label>Password
                    <input name="password" type="password" placeholder="••••••" required />
                </label>
            </div>
            <button type="submit">Login &amp; Lấy Token</button>
        </form>
        <div id="authResult" class="result-card">
            <h3>Login Response</h3>
            <div class="empty-state">Chưa đăng nhập.</div>
        </div>
    </section>

    <section>
        <h2>03 · Thông Tin Tài Khoản</h2>
        <div class="row">
            <button type="button" onclick="fetchCurrentUser()">Tải hồ sơ</button>
            <button type="button" onclick="fetchWallets()">Ví của tôi</button>
            <button type="button" onclick="fetchNotifications()">Thông báo</button>
            <button type="button" onclick="fetchMyActivities()">Hoạt động</button>
            <button type="button" onclick="fetchMyTrades()">Danh sách trade của tôi</button>
        </div>
        <div class="card-grid">
            <div id="currentUserCard" class="result-card">
                <h3>Current User</h3>
                <div class="empty-state">Chưa tải dữ liệu.</div>
            </div>
            <div id="walletCard" class="result-card">
                <h3>Wallet Balances</h3>
                <div class="empty-state">Chưa tải dữ liệu.</div>
            </div>
            <div id="notificationsCard" class="result-card">
                <h3>Notifications</h3>
                <div class="empty-state">Chưa tải dữ liệu.</div>
            </div>
            <div id="activitiesCard" class="result-card">
                <h3>Trades &amp; Orders</h3>
                <div class="empty-state">Chưa tải dữ liệu.</div>
            </div>
            <div id="myTradesResult" class="result-card">
                <h3>My Trades</h3>
                <div class="empty-state">Chưa tải dữ liệu.</div>
            </div>
        </div>
    </section>

    <section>
        <h2>04 · Orders</h2>
        <form id="p2pOrdersForm" onsubmit="handleP2POrders(event)">
            <div class="row">
                <label>Type
                    <select name="type">
                        <option value="">All</option>
                        <option value="BUY">BUY</option>
                        <option value="SELL">SELL</option>
                    </select>
                </label>
                <label>Token
                    <select name="token">
                        <option value="">All</option>
                        <option value="USDT">USDT</option>
                        <option value="BTC">BTC</option>
                        <option value="ETH">ETH</option>
                    </select>
                </label>
                <label>Fiat
                    <select name="fiat">
                        <option value="">All</option>
                        <option value="VND">VND</option>
                        <option value="USD">USD</option>
                    </select>
                </label>
            </div>
            <div class="row">
                <label>Status
                    <input name="status" placeholder="OPEN" />
                </label>
                <label>Page
                    <input name="page" type="number" min="0" value="0" />
                </label>
                <label>Size
                    <input name="size" type="number" min="1" value="10" />
                </label>
            </div>
            <button type="submit">List P2P Orders</button>
        </form>
        <div id="p2pOrdersResult" class="result-card">
            <h3>P2P Results</h3>
            <div class="empty-state">Chưa query.</div>
        </div>

        <form id="createOrderForm" onsubmit="handleCreateOrder(event)">
            <h3>Tạo Order</h3>
            <div class="row">
                <label>Type
                    <select name="type" required>
                        <option value="BUY">BUY</option>
                        <option value="SELL">SELL</option>
                    </select>
                </label>
                <label>Token
                    <div id="tokenChips" class="chip-bar">
                        <input type="hidden" name="token" value="USDT" />
                        <span class="chip active" data-token="USDT">USDT</span>
                        <span class="chip" data-token="BTC">BTC</span>
                        <span class="chip" data-token="ETH">ETH</span>
                    </div>
                </label>
                <label>Amount
                    <input name="amount" type="number" min="0" step="0.00000001" value="100" required />
                </label>
            </div>
            <div class="row">
                <label>Price Mode
                    <select id="priceModeSelect" name="priceMode">
                        <option value="CUSTOM" selected>CUSTOM</option>
                        <option value="MARKET">MARKET</option>
                    </select>
                </label>
                <label>Price
                    <input id="orderPrice" name="price" type="number" min="0" step="0.0001" value="25000" required />
                </label>
                <label>Fiat
                    <div id="fiatChips" class="chip-bar">
                        <input type="hidden" name="fiat" value="VND" />
                        <span class="chip active" data-fiat="VND">VND</span>
                        <span class="chip" data-fiat="USD">USD</span>
                    </div>
                </label>
            </div>
            <div class="row">
                <label>Payment Method
                    <input name="paymentMethod" placeholder="BANK" value="BANK" />
                </label>
                <label>Bank Name
                    <input name="bankName" placeholder="Vietcombank" />
                </label>
                <label>Bank Account
                    <input name="bankAccount" placeholder="0123456789" />
                </label>
                <label>Account Holder
                    <input name="accountHolder" placeholder="Nguyen Van A" />
                </label>
            </div>
            <div class="row">
                <label>Min Limit
                    <input name="minLimit" type="number" min="0" step="0.01" />
                </label>
                <label>Max Limit
                    <input name="maxLimit" type="number" min="0" step="0.01" />
                </label>
            </div>
            <button type="submit">Create Order</button>
        </form>
        <div id="createOrderResult" class="result-card">
            <h3>Order Created</h3>
            <div class="empty-state">Chưa tạo order.</div>
        </div>
    </section>

    <section>
        <h2>05 · Trades</h2>
        <form id="createTradeForm" onsubmit="handleCreateTrade(event)">
            <div class="row">
                <label>Order ID
                    <input name="orderId" type="number" min="1" required />
                </label>
                <label>Type
                    <select name="type" required>
                        <option value="BUY">BUY</option>
                        <option value="SELL">SELL</option>
                    </select>
                </label>
                <label>Amount
                    <input name="amount" type="number" min="0" step="0.00000001" required />
                </label>
                <label>Fiat Account ID
                    <input name="fiatAccountId" type="number" min="1" placeholder="Optional" />
                </label>
            </div>
            <div class="row">
                <label>Payment Type
                    <input name="paymentType" placeholder="BANK" />
                </label>
                <label>Bank Name
                    <input name="bankName" placeholder="Vietcombank" />
                </label>
                <label>Account Number
                    <input name="accountNumber" placeholder="0123456789" />
                </label>
                <label>Account Holder
                    <input name="accountHolder" placeholder="Nguyen Van B" />
                </label>
            </div>
            <div class="row">
                <label>Branch
                    <input name="branch" placeholder="HCM" />
                </label>
                <label>Chat Message
                    <input name="chatMessage" placeholder="Optional message" />
                </label>
            </div>
            <button type="submit">Create Trade</button>
        </form>
        <div id="tradeCreateResult" class="result-card">
            <h3>Trade Created</h3>
            <div class="empty-state">Chưa tạo trade.</div>
        </div>

        <div class="row" style="align-items:flex-end;">
            <label style="flex:1 1 180px;">Trade ID
                <input id="tradeActionId" type="number" min="1" placeholder="Nhập trade id" />
            </label>
            <button type="button" onclick="performTradeAction('confirm-payment')">Confirm Payment</button>
            <button type="button" onclick="performTradeAction('confirm-received')">Confirm Received</button>
            <button type="button" class="secondary" onclick="performTradeAction('cancel')">Cancel Trade</button>
        </div>
        <div id="tradeActionResult" class="result-card">
            <h3>Trade Action</h3>
            <div class="empty-state">Chưa thao tác.</div>
        </div>

        <form id="tradesByOrderForm" onsubmit="handleTradesByOrder(event)">
            <div class="row">
                <label>Order ID
                    <input name="orderId" type="number" min="1" required />
                </label>
                <button type="submit">List Trades by Order</button>
            </div>
        </form>
        <div id="tradesByOrderResult" class="result-card">
            <h3>Trades by Order</h3>
            <div class="empty-state">Chưa query.</div>
        </div>
    </section>

    <section>
        <h2>Raw JSON Output</h2>
        <div id="rawOutput" class="raw-output">Ready.</div>
    </section>
</main>

<script>
    const state = {
        baseUrl: 'http://localhost:8080',
        apiPrefix: '/api',
        token: null
    };

    const baseUrlInput = document.getElementById('baseUrl');
    const prefixInput = document.getElementById('apiPrefix');
    const tokenInput = document.getElementById('tokenInput');
    const activeTokenEl = document.getElementById('activeToken');
    const rawOutput = document.getElementById('rawOutput');
    const priceModeSelect = document.getElementById('priceModeSelect');
    const priceInput = document.querySelector('#createOrderForm input[name="price"]');

    function applyBaseUrl() {
        state.baseUrl = baseUrlInput.value.trim().replace(/\/$/, '') || 'http://localhost:8080';
        state.apiPrefix = normalisePrefix(prefixInput.value);
        prefixInput.value = state.apiPrefix;
        log(`API root set to ${getApiRoot()}`);
    }

    function normalisePrefix(prefix) {
        if (!prefix) return '';
        const trimmed = prefix.trim();
        return trimmed ? `/${trimmed.replace(/^\/+|\/+$|\s+/g, '')}` : '';
    }

    function getApiRoot() {
        const base = state.baseUrl.replace(/\/$/, '');
        return `${base}${state.apiPrefix || ''}`;
    }

    function normalisePath(path) {
        if (!path) return '';
        return path.startsWith('/') ? path : `/${path}`;
    }

    function setToken(token) {
        state.token = token || null;
        activeTokenEl.textContent = state.token || '(none)';
        tokenInput.value = state.token || '';
        try {
            if (state.token) {
                localStorage.setItem('p2p-demo-token', state.token);
            } else {
                localStorage.removeItem('p2p-demo-token');
            }
        } catch (_) {
            // ignore storage errors in non-browser environments
        }
    }

    function applyToken() {
        const value = tokenInput.value.trim();
        setToken(value || null);
        log(value ? 'Token applied.' : 'Token cleared.');
    }

    function clearToken() {
        setToken(null);
        log('Token cleared.');
    }

    async function apiFetch(path, options = {}) {
        const url = path.startsWith('http') ? path : `${getApiRoot()}${normalisePath(path)}`;
        const headers = { 'Content-Type': 'application/json', ...(options.headers || {}) };
        if (state.token) headers['Authorization'] = `Bearer ${state.token}`;
        const response = await fetch(url, { ...options, headers });
        const text = await response.text();
        let payload;
        try { payload = text ? JSON.parse(text) : null; } catch { payload = text; }
        if (!response.ok) throw { status: response.status, payload };
        return payload;
    }

    function log(message, data) {
        rawOutput.textContent = data !== undefined ? `${message}\n\n${JSON.stringify(data, null, 2)}` : message;
    }

    function formToJson(form) {
        const data = new FormData(form);
        const json = {};
        data.forEach((value, key) => {
            const field = form.elements[key];
            if (!field) return;
            if (field.type === 'checkbox') {
                json[key] = field.checked;
                return;
            }
            if (value === '') return;
            if (field.type === 'number') {
                const parsed = Number(value);
                json[key] = Number.isNaN(parsed) ? null : parsed;
            } else {
                json[key] = value;
            }
        });
        return json;
    }

    function buildQuery(params) {
        const search = new URLSearchParams();
        Object.entries(params).forEach(([k, v]) => {
            if (v !== undefined && v !== null && v !== '' && v !== false) search.append(k, v);
        });
        const qs = search.toString();
        return qs ? `?${qs}` : '';
    }

    function formatNumber(value) {
        if (value === undefined || value === null || value === '') return '';
        const num = Number(value);
        return Number.isNaN(num) ? value : num.toLocaleString(undefined, { maximumFractionDigits: 6 });
    }

    function formatDate(value) {
        if (!value) return '';
        try { return new Date(value).toLocaleString(); } catch { return value; }
    }

    function unwrapResult(response) {
        return response && typeof response === 'object' && 'result' in response ? response.result : response;
    }

    function renderResponseInfo(container, response) {
        if (!response || typeof response !== 'object') return;
        const info = document.createElement('div');
        info.className = 'info-line';
        const bits = [];
        if (response.status) bits.push(`<span class="pill ${response.status === 'success' ? 'success' : 'error'}">${response.status.toUpperCase()}</span>`);
        if (response.code !== undefined) bits.push(`Code: <strong>${response.code}</strong>`);
        if (response.message) bits.push(`Message: <strong>${response.message}</strong>`);
        if (bits.length) {
            info.innerHTML = bits.join(' · ');
            container.appendChild(info);
        }
    }

    function renderOrders(containerId, response) {
        const container = document.getElementById(containerId);
        container.innerHTML = `<h3>${containerId.includes('p2p') ? 'P2P' : 'Market'} Results</h3>`;
        renderResponseInfo(container, response);
        const data = unwrapResult(response);
        if (!Array.isArray(data) || data.length === 0) {
            container.innerHTML += '<div class="empty-state">No orders returned.</div>';
            return;
        }
        const table = document.createElement('table');
        table.innerHTML = '<thead><tr><th>ID</th><th>Type</th><th>Token</th><th>Price</th><th>Amount</th><th>Status</th><th>Payment</th></tr></thead>';
        const tbody = document.createElement('tbody');
        data.forEach(order => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${order.id ?? ''}</td>
                <td><span class="badge ${order.type ?? ''}">${order.type ?? ''}</span></td>
                <td>${order.token ?? ''}</td>
                <td>${formatNumber(order.price)}</td>
                <td>${formatNumber(order.amount)}</td>
                <td><span class="badge ${order.status ?? ''}">${order.status ?? ''}</span></td>
                <td>${order.paymentMethod ?? ''}</td>`;
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        container.appendChild(table);
        if (response.meta) {
            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.innerHTML = `
                <div>Page <strong>${response.meta.page}</strong> / <strong>${response.meta.totalPages}</strong></div>
                <div>Total: <strong>${response.meta.totalElements}</strong></div>
                <div>Has next: <strong>${response.meta.hasNext}</strong></div>
                <div>Has prev: <strong>${response.meta.hasPrevious}</strong></div>`;
            container.appendChild(meta);
        }
    }

    function renderJSON(containerId, title, response) {
        const container = document.getElementById(containerId);
        container.innerHTML = `<h3>${title}</h3>`;
        renderResponseInfo(container, response);
        const pre = document.createElement('pre');
        pre.className = 'raw-output';
        pre.textContent = JSON.stringify(response, null, 2);
        container.appendChild(pre);
    }

    function renderWallets(response) {
        const container = document.getElementById('walletCard');
        container.innerHTML = '<h3>Wallet Balances</h3>';
        renderResponseInfo(container, response);
        const data = unwrapResult(response);
        if (!Array.isArray(data) || data.length === 0) {
            container.innerHTML += '<div class="empty-state">No balances available.</div>';
            return;
        }
        const grid = document.createElement('div');
        grid.className = 'wallet-grid';
        data.forEach(wallet => {
            const card = document.createElement('div');
            card.className = 'wallet-card';
            card.innerHTML = `
                <h4>${wallet.token}</h4>
                <span>Total</span>
                <strong>${formatNumber(wallet.balance)}</strong>
                <span>Available</span>
                <strong>${formatNumber(wallet.availableBalance)}</strong>`;
            grid.appendChild(card);
        });
        container.appendChild(grid);
    }

    function renderNotifications(response) {
        const container = document.getElementById('notificationsCard');
        container.innerHTML = '<h3>Notifications</h3>';
        renderResponseInfo(container, response);
        const data = unwrapResult(response);
        if (!Array.isArray(data) || data.length === 0) {
            container.innerHTML += '<div class="empty-state">No notifications.</div>';
            return;
        }
        const list = document.createElement('div');
        list.className = 'notification-list';
        data.forEach(n => {
            const item = document.createElement('div');
            item.className = 'notification';
            item.innerHTML = `
                <h4>${n.message ?? 'No message'} <span class="pill ${n.read ? 'success' : 'error'}">${n.read ? 'READ' : 'NEW'}</span></h4>
                <time>${formatDate(n.createdAt)}</time>`;
            list.appendChild(item);
        });
        container.appendChild(list);
    }

    function renderUserProfile(response) {
        const container = document.getElementById('currentUserCard');
        container.innerHTML = '<h3>Current User</h3>';
        renderResponseInfo(container, response);
        const profile = unwrapResult(response);
        if (!profile) {
            container.innerHTML += '<div class="empty-state">No user info found.</div>';
            return;
        }
        const info = document.createElement('div');
        info.className = 'info-line';
        info.innerHTML = `ID: <strong>${profile.id ?? '-'}</strong> · Email: <strong>${profile.email ?? '-'}</strong> · Phone: <strong>${profile.phone ?? '-'}</strong> · KYC: <strong>${profile.kycStatus ?? '-'}</strong>`;
        container.appendChild(info);
        if (profile.wallets && profile.wallets.length) {
            const walletTitle = document.createElement('h4');
            walletTitle.textContent = 'Linked Wallets';
            container.appendChild(walletTitle);
            const grid = document.createElement('div');
            grid.className = 'wallet-grid';
            profile.wallets.forEach(w => {
                const card = document.createElement('div');
                card.className = 'wallet-card';
                card.innerHTML = `<h4>${w.token}</h4><span>Address</span><strong>${w.address ?? '-'}</strong><span>Balance</span><strong>${formatNumber(w.balance)}</strong>`;
                grid.appendChild(card);
            });
            container.appendChild(grid);
        }
    }

    function renderActivities(response) {
        const container = document.getElementById('activitiesCard');
        container.innerHTML = '<h3>Trades &amp; Orders</h3>';
        renderResponseInfo(container, response);
        const payload = unwrapResult(response);
        if (!payload) {
            container.innerHTML += '<div class="empty-state">No activity.</div>';
            return;
        }
        if (payload.orders && payload.orders.length) {
            const ordersTitle = document.createElement('h4');
            ordersTitle.textContent = 'Orders';
            container.appendChild(ordersTitle);
            const table = document.createElement('table');
            table.innerHTML = '<thead><tr><th>ID</th><th>Type</th><th>Token</th><th>Amount</th><th>Status</th></tr></thead>';
            const tbody = document.createElement('tbody');
            payload.orders.forEach(order => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${order.id ?? ''}</td><td><span class="badge ${order.type ?? ''}">${order.type ?? ''}</span></td><td>${order.token ?? ''}</td><td>${formatNumber(order.amount)}</td><td><span class="badge ${order.status ?? ''}">${order.status ?? ''}</span></td>`;
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            container.appendChild(table);
        }
        if (payload.trades && payload.trades.length) {
            const tradesTitle = document.createElement('h4');
            tradesTitle.textContent = 'Trades';
            container.appendChild(tradesTitle);
            const table = document.createElement('table');
            table.innerHTML = '<thead><tr><th>ID</th><th>Order</th><th>Buyer</th><th>Seller</th><th>Amount</th><th>Status</th></tr></thead>';
            const tbody = document.createElement('tbody');
            payload.trades.forEach(trade => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${trade.id ?? ''}</td><td>${trade.orderId ?? ''}</td><td>${trade.buyerId ?? ''}</td><td>${trade.sellerId ?? ''}</td><td>${formatNumber(trade.amount)}</td><td><span class="badge ${trade.status ?? ''}">${trade.status ?? ''}</span></td>`;
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            container.appendChild(table);
        }
        if ((!payload.orders || !payload.orders.length) && (!payload.trades || !payload.trades.length)) {
            container.innerHTML += '<div class="empty-state">No trades or orders recorded.</div>';
        }
    }

    function renderTrade(response, containerId, title) {
        renderJSON(containerId, title, response);
    }

    function renderTradesList(response, containerId, title) {
        const container = document.getElementById(containerId);
        container.innerHTML = `<h3>${title}</h3>`;
        renderResponseInfo(container, response);
        const data = unwrapResult(response);
        if (!Array.isArray(data) || data.length === 0) {
            container.innerHTML += '<div class="empty-state">No trades found.</div>';
            return;
        }
        const table = document.createElement('table');
        table.innerHTML = '<thead><tr><th>ID</th><th>Order</th><th>Buyer</th><th>Seller</th><th>Amount</th><th>Status</th><th>Escrow</th></tr></thead>';
        const tbody = document.createElement('tbody');
        data.forEach(trade => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${trade.id ?? ''}</td><td>${trade.orderId ?? ''}</td><td>${trade.buyerId ?? ''}</td><td>${trade.sellerId ?? ''}</td><td>${formatNumber(trade.amount)}</td><td><span class="badge ${trade.status ?? ''}">${trade.status ?? ''}</span></td><td>${trade.escrow ? 'Yes' : 'No'}</td>`;
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        container.appendChild(table);
    }

    async function handleLogin(event) {
        event.preventDefault();
        const payload = formToJson(event.target);
        try {
            const data = await apiFetch('/auth/login', { method: 'POST', body: JSON.stringify(payload) });
            const result = unwrapResult(data);
            if (result && result.token) {
                setToken(result.token);
            }
            renderJSON('authResult', 'Login Response', data);
            log('Login successful.', data);
            await fetchCurrentUser();
        } catch (error) {
            renderJSON('authResult', 'Login Failed', error);
            log('Login failed', error);
        }
    }

    async function handleP2POrders(event) {
        event.preventDefault();
        const payload = formToJson(event.target);
        const query = buildQuery(payload);
        try {
            const data = await apiFetch(`/p2p/orders${query}`);
            renderOrders('p2pOrdersResult', data);
            log('P2P orders fetched.', data);
        } catch (error) {
            renderJSON('p2pOrdersResult', 'Error', error);
            log('Failed to fetch P2P orders', error);
        }
    }

    async function handleCreateOrder(event) {
        event.preventDefault();
        const payload = formToJson(event.target);
        try {
            const data = await apiFetch('/p2p/orders', { method: 'POST', body: JSON.stringify(payload) });
            renderJSON('createOrderResult', 'Order Created', data);
            log('Order created.', data);
        } catch (error) {
            renderJSON('createOrderResult', 'Error', error);
            log('Failed to create order', error);
        }
    }

    async function fetchCurrentUser() {
        try {
            const data = await apiFetch('/p2p/me');
            renderUserProfile(data);
            log('Fetched current user.', data);
        } catch (error) {
            renderJSON('currentUserCard', 'Error', error);
            log('Failed to fetch current user', error);
        }
    }

    async function fetchMyActivities() {
        try {
            const data = await apiFetch('/p2p/my-activities');
            renderActivities(data);
            log('Fetched trades & orders.', data);
        } catch (error) {
            renderJSON('activitiesCard', 'Error', error);
            log('Failed to fetch activities', error);
        }
    }

    async function fetchWallets() {
        try {
            const data = await apiFetch('/p2p/wallets');
            renderWallets(data);
            log('Fetched wallets.', data);
        } catch (error) {
            renderJSON('walletCard', 'Error', error);
            log('Failed to fetch wallets', error);
        }
    }

    async function fetchNotifications() {
        try {
            const data = await apiFetch('/p2p/notifications?unreadOnly=false');
            renderNotifications(data);
            log('Fetched notifications.', data);
        } catch (error) {
            renderJSON('notificationsCard', 'Error', error);
            log('Failed to fetch notifications', error);
        }
    }

    async function fetchMyTrades() {
        try {
            const data = await apiFetch('/p2p/trades/me');
            renderTradesList(data, 'myTradesResult', 'My Trades');
            log('Fetched my trades.', data);
        } catch (error) {
            renderJSON('myTradesResult', 'Error', error);
            log('Failed to fetch my trades', error);
        }
    }

    async function handleCreateTrade(event) {
        event.preventDefault();
        const payload = formToJson(event.target);
        try {
            const data = await apiFetch('/p2p/trades', { method: 'POST', body: JSON.stringify(payload) });
            renderTrade(data, 'tradeCreateResult', 'Trade Created');
            log('Trade created.', data);
        } catch (error) {
            renderTrade(error, 'tradeCreateResult', 'Error');
            log('Failed to create trade', error);
        }
    }

    async function performTradeAction(action) {
        const tradeId = Number(document.getElementById('tradeActionId').value);
        if (!tradeId) {
            alert('Please enter a trade ID.');
            return;
        }
        let path;
        let title;
        if (action === 'confirm-payment') {
            path = `/p2p/trades/${tradeId}/confirm-payment`;
            title = 'Payment Confirmed';
        } else if (action === 'confirm-received') {
            path = `/p2p/trades/${tradeId}/confirm-received`;
            title = 'Receipt Confirmed';
        } else {
            path = `/p2p/trades/${tradeId}/cancel`;
            title = 'Trade Cancelled';
        }
        try {
            const data = await apiFetch(path, { method: 'POST' });
            renderTrade(data, 'tradeActionResult', title);
            log(`${title}.`, data);
        } catch (error) {
            renderTrade(error, 'tradeActionResult', 'Error');
            log('Trade action failed', error);
        }
    }

    async function handleTradesByOrder(event) {
        event.preventDefault();
        const { orderId } = formToJson(event.target);
        try {
            const data = await apiFetch(`/p2p/orders/${orderId}/trades`);
            renderTradesList(data, 'tradesByOrderResult', `Trades for Order ${orderId}`);
            log('Fetched trades for order.', data);
        } catch (error) {
            renderJSON('tradesByOrderResult', 'Error', error);
            log('Failed to fetch trades for order', error);
        }
    }

    function wireChipGroup(groupId, hiddenName) {
        const group = document.getElementById(groupId);
        if (!group) return;
        const hiddenInput = group.querySelector(`input[name="${hiddenName}"]`);
        if (!hiddenInput) return;
        group.addEventListener('click', (evt) => {
            const chip = evt.target.closest('.chip');
            if (!chip) return;
            group.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            hiddenInput.value = chip.dataset.token || chip.dataset.fiat || '';
        });
    }

    wireChipGroup('tokenChips', 'token');
    wireChipGroup('fiatChips', 'fiat');

    if (priceModeSelect && priceInput) {
        const togglePriceField = () => {
            const isMarket = priceModeSelect.value === 'MARKET';
            priceInput.disabled = isMarket;
            priceInput.required = !isMarket;
            if (isMarket) {
                priceInput.value = '';
                priceInput.placeholder = 'Auto pricing from market';
            } else if (!priceInput.value) {
                priceInput.placeholder = '';
                priceInput.value = '25000';
            }
        };
        priceModeSelect.addEventListener('change', togglePriceField);
        togglePriceField();
    }

    applyBaseUrl();
    const savedToken = (() => {
        try { return localStorage.getItem('p2p-demo-token'); } catch (_) { return null; }
    })();
    setToken(savedToken);
</script>
</body>
</html>
