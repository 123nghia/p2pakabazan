<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>P2P Trade Events</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; background: #f5f5f5; }
        h1 { color: #2c3e50; }
        #status { margin-bottom: 1rem; font-weight: bold; }
        #events { background: #fff; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); max-height: 60vh; overflow-y: auto; }
        .event { border-bottom: 1px solid #eee; padding: 0.75rem 0; }
        .event:last-child { border-bottom: none; }
        .meta { font-size: 0.9rem; color: #555; margin-top: 0.25rem; }
        label { display: block; margin-bottom: 0.35rem; }
        input { padding: 0.4rem; margin-right: 0.5rem; }
        button { padding: 0.45rem 0.9rem; cursor: pointer; }
    </style>
</head>
<body>
<h1>Trade Events Monitor</h1>
<div>
    <label>
        User ID:
        <input type="number" id="userId" placeholder="Optional, e.g. 42">
    </label>
    <label>
        Trade ID:
        <input type="number" id="tradeId" placeholder="Optional, e.g. 1001">
    </label>
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
</div>
<div id="status">Disconnected</div>
<div id="events"></div>

<script>
    let stompClient = null;
    const eventsContainer = document.getElementById('events');
    const statusEl = document.getElementById('status');

    function connect() {
        if (stompClient && stompClient.connected) {
            return;
        }
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {
            statusEl.textContent = 'Connected';
            addLog('Connected to /ws');

            stompClient.subscribe('/topic/trades', onEvent);

            const userId = document.getElementById('userId').value;
            if (userId) {
                stompClient.subscribe(`/topic/users/${userId}/trades`, onEvent);
                addLog(`Subscribed to /topic/users/${userId}/trades`);
            }

            const tradeId = document.getElementById('tradeId').value;
            if (tradeId) {
                stompClient.subscribe(`/topic/trades/${tradeId}`, onEvent);
                addLog(`Subscribed to /topic/trades/${tradeId}`);
            }
        }, (error) => {
            statusEl.textContent = 'Connection error';
            addLog('Connection error: ' + error);
        });
    }

    function disconnect() {
        if (stompClient) {
            stompClient.disconnect(() => {
                statusEl.textContent = 'Disconnected';
                addLog('Disconnected');
            });
            stompClient = null;
        }
    }

    function onEvent(message) {
        if (!message.body) {
            return;
        }
        const data = JSON.parse(message.body);
        const div = document.createElement('div');
        div.className = 'event';
        div.innerHTML = `
            <div><strong>Status:</strong> ${data.status}</div>
            <div class="meta">
                Trade #${data.tradeId ?? 'N/A'} | Order #${data.orderId ?? 'N/A'}<br>
                Buyer: ${data.buyerId ?? 'N/A'} | Seller: ${data.sellerId ?? 'N/A'}<br>
                Amount: ${data.amount ?? 0} | Time: ${data.occurredAt}
            </div>
        `;
        eventsContainer.prepend(div);
    }

    function addLog(text) {
        const div = document.createElement('div');
        div.className = 'event';
        div.textContent = text;
        eventsContainer.prepend(div);
    }
</script>
</body>
</html>
