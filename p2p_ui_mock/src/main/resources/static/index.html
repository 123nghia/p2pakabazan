<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>P2P UI Mock - SSO Exchange</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 32px; background: #0b1220; color: #e6edf3; }
    .card { max-width: 980px; background: #111a2b; border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 18px 18px; }
    h1 { margin: 0 0 8px; font-size: 20px; }
    h2 { margin: 18px 0 10px; font-size: 16px; }
    p { margin: 0 0 14px; color: rgba(230,237,243,.78); }
    .grid { display: grid; grid-template-columns: 180px 1fr; gap: 10px; align-items: center; margin: 10px 0; }
    code { background: rgba(255,255,255,.06); padding: 2px 6px; border-radius: 8px; }
    input { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: #e6edf3; }
    select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: #e6edf3; }
    textarea { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: #e6edf3; min-height: 76px; resize: vertical; }
    button { padding: 10px 12px; border-radius: 10px; border: 0; background: #1f6feb; color: #fff; font-weight: 700; cursor: pointer; }
    .btn-secondary { background: rgba(255,255,255,.10); color: #e6edf3; }
    pre { white-space: pre-wrap; word-break: break-word; background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); padding: 12px; border-radius: 12px; margin: 12px 0 0; }
    a { color: #7db4ff; text-decoration: none; }
    .hint { font-size: 13px; color: rgba(230,237,243,.72); margin-top: 12px; }
    .divider { margin-top: 16px; border-top: 1px solid rgba(255,255,255,.08); padding-top: 10px; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  </style>
  <script src="/config.js"></script>
</head>
<body>
<div class="card">
  <h1>P2P UI Mock (port 9898)</h1>
  <p>Nhận <code>?code=...</code> từ partner redirect, gọi <code>POST /api/sso/exchange</code> sang P2P API để lấy JWT, sau đó gọi <code>GET /api/me</code>.</p>

  <div class="grid">
    <div>P2P API base URL</div>
    <input id="apiBaseUrl" placeholder="http://localhost:9999"/>
  </div>

  <div class="grid">
    <div>One-time code</div>
    <input id="code" placeholder="Paste code here (or from ?code=...)" />
  </div>

  <div class="grid">
    <div></div>
    <div style="display:flex; gap:10px; flex-wrap:wrap">
      <button id="btnExchange">Exchange</button>
      <button id="btnMe" class="btn-secondary">Call /api/me</button>
      <button id="btnBalances" class="btn-secondary">Balances</button>
      <button id="btnClear" class="btn-secondary">Clear</button>
      <a id="swaggerLink" href="#" target="_blank" style="align-self:center">Swagger</a>
    </div>
  </div>

  <div class="divider">
    <h2>Tokens A/B (multi-user)</h2>
    <div class="grid">
      <div>Token source</div>
      <select id="tokenSource">
        <option value="current">Current (localStorage.p2p_jwt)</option>
        <option value="a">Token A</option>
        <option value="b">Token B</option>
      </select>
    </div>
    <div class="two-col">
      <div>
        <div style="margin-bottom:6px; font-weight:700">Token A</div>
        <textarea id="tokenA" placeholder="Paste token A here"></textarea>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
          <button id="btnSaveA" class="btn-secondary">Save A</button>
          <button id="btnCopyToA" class="btn-secondary">Copy current → A</button>
        </div>
      </div>
      <div>
        <div style="margin-bottom:6px; font-weight:700">Token B</div>
        <textarea id="tokenB" placeholder="Paste token B here"></textarea>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
          <button id="btnSaveB" class="btn-secondary">Save B</button>
          <button id="btnCopyToB" class="btn-secondary">Copy current → B</button>
        </div>
      </div>
    </div>
    <div class="hint">Tip: Exchange user#1 → copy to A, Exchange user#2 → copy to B. Create order using A, create trade using B (must be different users).</div>
  </div>

  <div class="divider">
    <h2>Create order (Tạo tin rao)</h2>
    <div class="two-col">
      <div>
        <div class="grid">
          <div>Type</div>
          <select id="orderType">
            <option value="SELL">SELL</option>
            <option value="BUY">BUY</option>
          </select>
        </div>
        <div class="grid">
          <div>Token</div>
          <input id="orderToken" placeholder="USDT" />
        </div>
        <div class="grid">
          <div>Fiat</div>
          <input id="orderFiat" placeholder="VND" />
        </div>
        <div class="grid">
          <div>Payment method</div>
          <input id="orderPaymentMethod" placeholder="BANK_TRANSFER" />
        </div>
      </div>
      <div>
        <div class="grid">
          <div>Amount</div>
          <input id="orderAmount" placeholder="10" />
        </div>
        <div class="grid">
          <div>Price</div>
          <input id="orderPrice" placeholder="25000" />
        </div>
        <div class="grid">
          <div>Price mode</div>
          <select id="orderPriceMode">
            <option value="CUSTOM">CUSTOM</option>
            <option value="MARKET">MARKET</option>
          </select>
        </div>
        <div class="grid">
          <div>Min/Max limit</div>
          <div style="display:flex; gap:10px">
            <input id="orderMinLimit" placeholder="min (optional)" />
            <input id="orderMaxLimit" placeholder="max (optional)" />
          </div>
        </div>
      </div>
    </div>
    <div style="display:flex; gap:10px; flex-wrap:wrap">
      <button id="btnCreateOrder">Create order</button>
    </div>
  </div>

  <div class="divider">
    <h2>Create trade</h2>
    <div class="two-col">
      <div>
        <div class="grid">
          <div>Order ID</div>
          <input id="tradeOrderId" placeholder="UUID from created order" />
        </div>
        <div class="grid">
          <div>Amount</div>
          <input id="tradeAmount" placeholder="1" />
        </div>
        <div class="grid">
          <div>Chat message</div>
          <input id="tradeMessage" placeholder="optional" />
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button id="btnCreateTrade">Create trade</button>
        </div>
      </div>
      <div>
        <div class="grid">
          <div>Trade ID</div>
          <input id="tradeId" placeholder="UUID from create trade response" />
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button id="btnConfirmPayment" class="btn-secondary">Confirm payment</button>
          <button id="btnConfirmReceived" class="btn-secondary">Confirm received</button>
          <button id="btnGetTradeInfo" class="btn-secondary">Get trade</button>
        </div>
      </div>
    </div>
  </div>

  <pre id="out">Waiting…</pre>
  <div class="hint">
    Lưu JWT ở <code>localStorage.p2p_jwt</code>. One-time code chỉ dùng 1 lần.
  </div>
</div>

<script>
  const out = document.getElementById('out');
  const codeInput = document.getElementById('code');
  const apiBaseUrlInput = document.getElementById('apiBaseUrl');
  const swaggerLink = document.getElementById('swaggerLink');
  const tokenSourceSelect = document.getElementById('tokenSource');
  const tokenAInput = document.getElementById('tokenA');
  const tokenBInput = document.getElementById('tokenB');

  const orderTypeSelect = document.getElementById('orderType');
  const orderTokenInput = document.getElementById('orderToken');
  const orderFiatInput = document.getElementById('orderFiat');
  const orderPaymentMethodInput = document.getElementById('orderPaymentMethod');
  const orderAmountInput = document.getElementById('orderAmount');
  const orderPriceInput = document.getElementById('orderPrice');
  const orderPriceModeSelect = document.getElementById('orderPriceMode');
  const orderMinLimitInput = document.getElementById('orderMinLimit');
  const orderMaxLimitInput = document.getElementById('orderMaxLimit');

  const tradeOrderIdInput = document.getElementById('tradeOrderId');
  const tradeAmountInput = document.getElementById('tradeAmount');
  const tradeMessageInput = document.getElementById('tradeMessage');
  const tradeIdInput = document.getElementById('tradeId');

  const TOKEN_KEY_CURRENT = 'p2p_jwt';
  const TOKEN_KEY_A = 'p2p_jwt_a';
  const TOKEN_KEY_B = 'p2p_jwt_b';
  const TOKEN_SOURCE_KEY = 'p2p_token_source';

  function setOut(obj) {
    out.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
  }

  function normalizeBaseUrl(url) {
    if (!url) return '';
    return url.endsWith('/') ? url.slice(0, -1) : url;
  }

  function readConfig() {
    const fromServer = (window.P2P_UI_CONFIG && window.P2P_UI_CONFIG.apiBaseUrl) ? window.P2P_UI_CONFIG.apiBaseUrl : '';
    const fromStorage = localStorage.getItem('p2p_api_base_url') || '';
    return normalizeBaseUrl(fromStorage || fromServer || 'http://localhost:9999');
  }

  function writeConfig(url) {
    localStorage.setItem('p2p_api_base_url', normalizeBaseUrl(url));
  }

  function parseCodeFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    if (code) codeInput.value = code;
  }

  function readTokenSource() {
    return localStorage.getItem(TOKEN_SOURCE_KEY) || 'current';
  }

  function writeTokenSource(value) {
    localStorage.setItem(TOKEN_SOURCE_KEY, value || 'current');
  }

  function resolveToken() {
    const source = tokenSourceSelect ? tokenSourceSelect.value : 'current';
    if (source === 'a') return ((tokenAInput && tokenAInput.value) || localStorage.getItem(TOKEN_KEY_A) || '').trim();
    if (source === 'b') return ((tokenBInput && tokenBInput.value) || localStorage.getItem(TOKEN_KEY_B) || '').trim();
    return (localStorage.getItem(TOKEN_KEY_CURRENT) || '').trim();
  }

  function parseNumberOrNull(value) {
    const raw = (value || '').trim();
    if (!raw) return null;
    const n = Number(raw);
    return Number.isFinite(n) ? n : null;
  }

  async function apiCall(method, path, body) {
    const apiBaseUrl = normalizeBaseUrl(apiBaseUrlInput.value.trim());
    if (!apiBaseUrl) { setOut('Missing apiBaseUrl'); return null; }
    writeConfig(apiBaseUrl);
    refreshLinks();

    const token = resolveToken();
    if (!token) { setOut('Missing token (select Token source or exchange first)'); return null; }

    const headers = { 'Authorization': 'Bearer ' + token };
    if (body !== undefined) headers['Content-Type'] = 'application/json';

    const resp = await fetch(apiBaseUrl + path, {
      method,
      headers,
      body: body === undefined ? undefined : JSON.stringify(body)
    });
    const json = await resp.json().catch(() => null);
    return { resp, json };
  }

  async function exchange() {
    const apiBaseUrl = normalizeBaseUrl(apiBaseUrlInput.value.trim());
    const code = (codeInput.value || '').trim();
    if (!apiBaseUrl) { setOut('Missing apiBaseUrl'); return; }
    if (!code) { setOut('Missing code'); return; }

    writeConfig(apiBaseUrl);
    setOut('Exchanging code…');

    const exchangeResp = await fetch(apiBaseUrl + '/api/sso/exchange', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    });

    const exchangeJson = await exchangeResp.json().catch(() => null);
    if (!exchangeResp.ok) {
      setOut({ step: 'exchange', http: exchangeResp.status, body: exchangeJson });
      return;
    }

    const token = exchangeJson?.result?.token;
    const userId = exchangeJson?.result?.userId;
    if (!token) {
      setOut({ step: 'exchange', error: 'Missing token in response', body: exchangeJson });
      return;
    }

    localStorage.setItem('p2p_jwt', token);
    setOut({ step: 'exchange', userId, token, note: 'Saved to localStorage.p2p_jwt' });
  }

  async function callMe() {
    setOut('Calling /api/me…');
    const result = await apiCall('GET', '/api/me');
    if (!result) return;
    setOut({ step: 'me', http: result.resp.status, body: result.json });
  }

  async function callBalances() {
    setOut('Calling /api/p2p/wallets…');
    const result = await apiCall('GET', '/api/p2p/wallets');
    if (!result) return;
    setOut({ step: 'balances', http: result.resp.status, body: result.json });
  }

  async function createOrder() {
    const type = (orderTypeSelect && orderTypeSelect.value) ? orderTypeSelect.value : 'SELL';
    const token = (orderTokenInput && orderTokenInput.value ? orderTokenInput.value : 'USDT').trim();
    const fiat = (orderFiatInput && orderFiatInput.value ? orderFiatInput.value : 'VND').trim();
    const paymentMethod = (orderPaymentMethodInput && orderPaymentMethodInput.value ? orderPaymentMethodInput.value : 'BANK_TRANSFER').trim();
    const priceMode = (orderPriceModeSelect && orderPriceModeSelect.value) ? orderPriceModeSelect.value : 'CUSTOM';
    const amount = parseNumberOrNull(orderAmountInput ? orderAmountInput.value : '');
    const price = parseNumberOrNull(orderPriceInput ? orderPriceInput.value : '');
    const minLimit = parseNumberOrNull(orderMinLimitInput ? orderMinLimitInput.value : '');
    const maxLimit = parseNumberOrNull(orderMaxLimitInput ? orderMaxLimitInput.value : '');

    if (!token) { setOut('Missing order token'); return; }
    if (!fiat) { setOut('Missing fiat'); return; }
    if (!paymentMethod) { setOut('Missing paymentMethod'); return; }
    if (!amount || amount <= 0) { setOut('Invalid amount'); return; }
    if (!price || price <= 0) { setOut('Invalid price'); return; }

    const body = { type, token, amount, price, fiat, priceMode, paymentMethod };
    if (minLimit != null) body.minLimit = minLimit;
    if (maxLimit != null) body.maxLimit = maxLimit;

    setOut({ step: 'createOrder', request: body });
    const result = await apiCall('POST', '/api/p2p/orders', body);
    if (!result) return;

    const orderId = result.json?.result?.id;
    if (orderId && tradeOrderIdInput && !tradeOrderIdInput.value) {
      tradeOrderIdInput.value = orderId;
    }

    setOut({ step: 'createOrder', http: result.resp.status, body: result.json });
  }

  async function createTrade() {
    const orderId = (tradeOrderIdInput && tradeOrderIdInput.value ? tradeOrderIdInput.value : '').trim();
    const amount = parseNumberOrNull(tradeAmountInput ? tradeAmountInput.value : '');
    const chatMessage = (tradeMessageInput && tradeMessageInput.value ? tradeMessageInput.value : '').trim();

    if (!orderId) { setOut('Missing orderId'); return; }
    if (!amount || amount <= 0) { setOut('Invalid trade amount'); return; }

    const body = { orderId, amount };
    if (chatMessage) body.chatMessage = chatMessage;

    setOut({ step: 'createTrade', request: body });
    const result = await apiCall('POST', '/api/p2p/trades', body);
    if (!result) return;

    const tradeId = result.json?.result?.id;
    if (tradeId && tradeIdInput) {
      tradeIdInput.value = tradeId;
    }

    setOut({ step: 'createTrade', http: result.resp.status, body: result.json });
  }

  async function confirmPayment() {
    const tradeId = (tradeIdInput && tradeIdInput.value ? tradeIdInput.value : '').trim();
    if (!tradeId) { setOut('Missing tradeId'); return; }
    setOut('Confirming payment…');
    const result = await apiCall('POST', '/api/p2p/trades/' + tradeId + '/confirm-payment', {});
    if (!result) return;
    setOut({ step: 'confirmPayment', http: result.resp.status, body: result.json });
  }

  async function confirmReceived() {
    const tradeId = (tradeIdInput && tradeIdInput.value ? tradeIdInput.value : '').trim();
    if (!tradeId) { setOut('Missing tradeId'); return; }
    setOut('Confirming received…');
    const result = await apiCall('POST', '/api/p2p/trades/' + tradeId + '/confirm-received', {});
    if (!result) return;
    setOut({ step: 'confirmReceived', http: result.resp.status, body: result.json });
  }

  async function getTradeInfo() {
    const tradeId = (tradeIdInput && tradeIdInput.value ? tradeIdInput.value : '').trim();
    if (!tradeId) { setOut('Missing tradeId'); return; }
    setOut('Fetching trade info…');
    const result = await apiCall('GET', '/api/p2p/trades/' + tradeId);
    if (!result) return;
    setOut({ step: 'getTradeInfo', http: result.resp.status, body: result.json });
  }

  function refreshLinks() {
    const apiBaseUrl = normalizeBaseUrl(apiBaseUrlInput.value.trim());
    swaggerLink.href = apiBaseUrl + '/api/swagger-ui/index.html';
  }

  document.getElementById('btnExchange').addEventListener('click', () => exchange().catch(e => setOut(String(e))));
  document.getElementById('btnMe').addEventListener('click', () => callMe().catch(e => setOut(String(e))));
  document.getElementById('btnBalances').addEventListener('click', () => callBalances().catch(e => setOut(String(e))));
  document.getElementById('btnCreateOrder').addEventListener('click', () => createOrder().catch(e => setOut(String(e))));
  document.getElementById('btnCreateTrade').addEventListener('click', () => createTrade().catch(e => setOut(String(e))));
  document.getElementById('btnConfirmPayment').addEventListener('click', () => confirmPayment().catch(e => setOut(String(e))));
  document.getElementById('btnConfirmReceived').addEventListener('click', () => confirmReceived().catch(e => setOut(String(e))));
  document.getElementById('btnGetTradeInfo').addEventListener('click', () => getTradeInfo().catch(e => setOut(String(e))));
  document.getElementById('btnClear').addEventListener('click', () => { codeInput.value = ''; setOut('Cleared'); });
  apiBaseUrlInput.addEventListener('input', refreshLinks);
  if (tokenSourceSelect) tokenSourceSelect.addEventListener('change', () => writeTokenSource(tokenSourceSelect.value));

  if (document.getElementById('btnSaveA')) {
    document.getElementById('btnSaveA').addEventListener('click', () => {
      localStorage.setItem(TOKEN_KEY_A, (tokenAInput.value || '').trim());
      setOut({ step: 'token', message: 'Saved token A' });
    });
  }
  if (document.getElementById('btnSaveB')) {
    document.getElementById('btnSaveB').addEventListener('click', () => {
      localStorage.setItem(TOKEN_KEY_B, (tokenBInput.value || '').trim());
      setOut({ step: 'token', message: 'Saved token B' });
    });
  }
  if (document.getElementById('btnCopyToA')) {
    document.getElementById('btnCopyToA').addEventListener('click', () => {
      const current = localStorage.getItem(TOKEN_KEY_CURRENT) || '';
      tokenAInput.value = current;
      localStorage.setItem(TOKEN_KEY_A, current);
      setOut({ step: 'token', message: 'Copied current -> A' });
    });
  }
  if (document.getElementById('btnCopyToB')) {
    document.getElementById('btnCopyToB').addEventListener('click', () => {
      const current = localStorage.getItem(TOKEN_KEY_CURRENT) || '';
      tokenBInput.value = current;
      localStorage.setItem(TOKEN_KEY_B, current);
      setOut({ step: 'token', message: 'Copied current -> B' });
    });
  }

  apiBaseUrlInput.value = readConfig();
  refreshLinks();
  parseCodeFromUrl();

  if (tokenSourceSelect) tokenSourceSelect.value = readTokenSource();
  if (tokenAInput) tokenAInput.value = localStorage.getItem(TOKEN_KEY_A) || '';
  if (tokenBInput) tokenBInput.value = localStorage.getItem(TOKEN_KEY_B) || '';

  if (orderTokenInput && !orderTokenInput.value) orderTokenInput.value = 'USDT';
  if (orderFiatInput && !orderFiatInput.value) orderFiatInput.value = 'VND';
  if (orderPaymentMethodInput && !orderPaymentMethodInput.value) orderPaymentMethodInput.value = 'BANK_TRANSFER';
  if (orderAmountInput && !orderAmountInput.value) orderAmountInput.value = '10';
  if (orderPriceInput && !orderPriceInput.value) orderPriceInput.value = '25000';
  if (tradeAmountInput && !tradeAmountInput.value) tradeAmountInput.value = '1';
</script>
</body>
</html>
